#!/bin/bash

#author Tomasz Bold AGH-UST, Krakow

LP=.load.py
echo "" > $LP
PRE=.before_load.py
echo "" > $PRE
AFTER=.after_load.py
echo "" > $AFTER

echo "import readline" >> $PRE
echo "import rlcompleter" >> $PRE
#echo "readline.parse_and_bind(\"bind -e\")" >> $PRE
#echo "readline.parse_and_bind(\"bind '\t' rl_complete\")" >> $PRE


echo "import ROOT" >> $PRE
echo "print ('welcome to piROOT - opening files')" >> $PRE
echo "global _files" >> $PRE
echo "_files=[]" >> $PRE


echo "def _():" >> $LP
printf "\tfor k in list(ROOT.gDirectory.GetListOfKeys()):\n" >> $LP
printf "\t\texec( '%%s = ROOT.gDirectory.Get(\"%%s\")' %% (k.GetName(), k.GetName()), globals())\n\n" >> $LP


pcode=0
acode=0
SAVIFS=$IFS
IFS=""
fcount=0
interactive="-i"
for OPTION in "$@"
do
    if [ $pcode -eq 1 -a ${OPTION} != '-a' ]
   	then

   	    echo -n ${OPTION}" " >> $PRE
   	    continue
    fi

    if [ $acode -eq 1 ]
   	then
   	    echo -n ${OPTION}" " >> $AFTER
   	    continue
    fi


    case $OPTION in
        '-p')
            pcode=1
            ;;
        '-a')
	        acode=1
            pcode=0
            ;;
        '-q')
            interactive=""
            ;;
        *)
            f=${OPTION}
            if [[ "$f" =~ .*".py" ]]
            then
                if [ -f "$f" ]
                then
                    echo "exec(open('$f').read())" >> $LP
                elif [ -f "$QUICK_ROOT_PLOTS/$f" ]
                then
                    echo "exec(open('$QUICK_ROOT_PLOTS/$f').read())" >> $LP
                else
        		    echo ".. File does not exist :" $f " in local dir nor in " $QUICK_ROOT_PLOTS
                    exit -1
                fi
            else
                echo "global _file$fcount" >> $LP
                echo "_file$fcount = ROOT.TFile('$f',\"OLD\")"  >> $LP
                echo "_files.append(_file$fcount)" >> $LP
                echo "print ('.opening', \"$f\")" >> $LP
                echo "ROOT.gROOT.cd()" >> $LP
                fcount=$(($fcount + 1))
            fi
    esac
done
IFS=$SAVIFS

#echo "preparing the launching script"
echo "#generated by the pyroot" > .ll.py
cat $PRE > .ll.py

cat $LP >> .ll.py
cat $AFTER >> .ll.py
if [ "$PYTHONSTARTUP" != ""  -a -f "$PYTHONSTARTUP" ]
then
    cat $PYTHONSTARTUP >> .ll.py
fi

echo "...starting python"
python3.10 $interactive .ll.py
